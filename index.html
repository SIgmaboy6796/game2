<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call-Of-Zdenek</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            color: white;
        }
        canvas {
            display: block;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
        }
        .menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .menu h2 {
            margin-top: 0;
        }
        .menu button {
            background-color: #444;
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .menu button:hover {
            background-color: #666;
        }
        #ammoCounter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 24px;
            font-family: monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #healthBar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 20px;
            background-color: red;
            border: 2px solid white;
        }
        #health {
            width: 100%;
            height: 100%;
            background-color: green;
        }
        #lobby {
            display: none; /* Initially hidden */
            padding: 20px;
        }
        #debugPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div id="mainMenu" class="container text-center mt-5">
        <h1>Call-Of-Zdenek</h1>
        <div class="form-group">
            <label for="nametagInput">Enter Your Nametag:</label>
            <input type="text" class="form-control" id="nametagInput" placeholder="Player">
        </div>
        <button id="singlePlayerButton" class="btn btn-primary">Single Player</button>
        <button id="multiplayerButton" class="btn btn-success">Multiplayer</button>
    </div>

    <div id="lobby" class="container mt-5 text-center">
        <h2>Multiplayer</h2>
        <div id="lobby-choice">
            <button id="hostChoiceButton" class="btn btn-primary btn-lg">Host Game</button>
            <button id="joinChoiceButton" class="btn btn-success btn-lg">Join Game</button>
            <button id="backToMainButton" class="btn btn-secondary mt-3">Back to Main Menu</button>
        </div>
        
        <div id="host-lobby" class="mt-3" style="display: none;">
            <h3>You are the Host</h3>
            <p>Share this ID with your friends:</p>
            <div class="input-group mb-3">
                <input type="text" id="hostIdDisplay" class="form-control" readonly placeholder="Waiting for ID...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" id="copyIdButton">Copy</button>
                </div>
            </div>
            <h4>Players in Lobby:</h4>
            <ul id="playerList" class="list-group mb-3"></ul>
            <button id="startGameButton" class="btn btn-success btn-lg">Start Game</button>
        </div>

        <div id="join-lobby" class="mt-3" style="display: none;">
            <h3>Join a Game</h3>
            <input type="text" id="joinIdInput" class="form-control mb-2" placeholder="Enter Room Code">
            <button id="connectToHostButton" class="btn btn-success">Connect</button>
        </div>
    </div>

    <div id="game-ui" style="display: none;">
        <div id="ammoCounter"></div>
        <div id="healthBar">
            <div id="health"></div>
        </div>
        <div class="crosshair"></div>
        <div id="networkStatus" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; background-color: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; display: none;"></div>
        <div id="pauseMenu" class="menu" style="display: none;">
            <h2>Paused</h2>
            <button id="resumeButton">Resume</button>
            <button id="keybindsButton">Keybinds</button>
        </div>
        <div id="keybindsMenu" class="menu" style="display: none;">
            <h2>Keybinds</h2>
            <p>Move Forward: W</p>
            <p>Move Left: A</p>
            <p>Move Backward: S</p>
            <p>Move Right: D</p>
            <p>Jump: Space</p>
            <p>Pick Up Weapon: F</p>
            <p>Reload: R</p>
            <p>Shoot: Left Click</p>
            <p>Select Pistol: 1</p>
            <p>Select Shotgun: 2</p>
            <p>Select Rocket Launcher: 3</p>
            <button id="backButton">Back</button>
        </div>
    </div>

    <script type="importmap">
        { "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js",
            "peerjs": "https://cdn.jsdelivr.net/npm/peerjs@1.5.2/+esm"
        } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { init as initGame, players } from '/game.js';
        import { initNetwork, connectToHost, sendData, getConnections, getMyId, setAsHost, hostGame, getHostPeerId } from '/network.js';

        const mainMenu = document.getElementById('mainMenu');
        const lobby = document.getElementById('lobby');
        const gameUi = document.getElementById('game-ui');

        // Main Menu
        const nametagInput = document.getElementById('nametagInput');
        const singlePlayerButton = document.getElementById('singlePlayerButton');
        const multiplayerButton = document.getElementById('multiplayerButton');

        // Lobby elements
        const lobbyChoice = document.getElementById('lobby-choice');
        const hostLobby = document.getElementById('host-lobby');
        const joinLobby = document.getElementById('join-lobby');

        const playerList = document.getElementById('playerList');
        const networkStatus = document.getElementById('networkStatus');
        
        const hostChoiceButton = document.getElementById('hostChoiceButton');
        const joinChoiceButton = document.getElementById('joinChoiceButton');
        const backToMainButton = document.getElementById('backToMainButton');
        const hostIdDisplay = document.getElementById('hostIdDisplay');
        const copyIdButton = document.getElementById('copyIdButton');
        const startGameButton = document.getElementById('startGameButton');
        const joinIdInput = document.getElementById('joinIdInput');
        const connectToHostButton = document.getElementById('connectToHostButton');

        let nametag = 'Player';
        let isHost = false;
        let myPeerId = null; // Variable to store our own peer ID
        let isMultiplayer = false;
        let gameScene = null; // Will hold the THREE.Scene instance
        let shootHandler = null; // Will hold the handleShoot function
        let gameFont = null; // Will hold the loaded font
        const playerCreateQueue = []; // Queue for players that arrive before the game scene is ready

        function showNetworkStatus(message, isError = false) {
            networkStatus.textContent = message;
            networkStatus.style.backgroundColor = isError ? 'red' : 'rgba(0,0,0,0.5)';
            networkStatus.style.display = 'block';
            setTimeout(() => networkStatus.style.display = 'none', 3000);
        }

        function updatePlayerList(players) {
            playerList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = player.nametag;
                playerList.appendChild(li);
            });
        }

        function launchSinglePlayerGame() {
            isMultiplayer = false;
            nametag = nametagInput.value.trim() || 'Player';
            mainMenu.style.display = 'none';
            lobby.style.display = 'none';
            gameUi.style.display = 'block';
            initGame(nametag, false);
        }

        function initLobby() {
            nametag = nametagInput.value.trim() || `Player-${Math.floor(1000 + Math.random() * 9000)}`;
            mainMenu.style.display = 'none';
            lobby.style.display = 'flex'; // Use flex for centering
            initNetwork(nametag);
        }

        function launchMultiplayerGame() {
            isMultiplayer = true;
            mainMenu.style.display = 'none';
            lobby.style.display = 'none';
            gameUi.style.display = 'block';
            initGame(nametag, true, isHost);
        }

        singlePlayerButton.addEventListener('click', launchSinglePlayerGame);

        multiplayerButton.addEventListener('click', initLobby);

        hostChoiceButton.addEventListener('click', () => {
            console.log('[UI] Host button clicked.');
            isHost = true;
            setAsHost(); // Tell the network layer that we are the host.
            lobbyChoice.style.display = 'none';
            hostLobby.style.display = 'block'; 
            showNetworkStatus('Requesting room code from server...');
            // If peer is ready, host immediately. Otherwise, the 'peer-ready' event will trigger it.
            if (myPeerId) hostGame(myPeerId);
            updatePlayerList([{ nametag }]);
        });

        joinChoiceButton.addEventListener('click', () => {
            lobbyChoice.style.display = 'none';
            joinLobby.style.display = 'block';
            joinIdInput.focus();
        });

        backToMainButton.addEventListener('click', () => {
            lobby.style.display = 'none';
            mainMenu.style.display = 'block';
            // TODO: Should also disconnect from peerjs if connected
        });

        copyIdButton.addEventListener('click', () => {
            navigator.clipboard.writeText(hostIdDisplay.value).then(() => {
                showNetworkStatus('Room Code copied to clipboard!');
            });
        });

        connectToHostButton.addEventListener('click', () => {
            const roomCode = joinIdInput.value.trim().toUpperCase();
            if (roomCode && roomCode.length === 4) {
                showNetworkStatus(`Looking up room ${roomCode}...`);
                getHostPeerId(roomCode); // Ask matchmaking server for the host's real PeerJS ID
            } else {
                showNetworkStatus('Please enter a valid 4-letter room code.', true);
            }
        });

        startGameButton.addEventListener('click', () => {
            console.log('[UI] Start Game button clicked by host.');
            sendData({ type: 'start-game' });
            launchMultiplayerGame();
        });

        // --- GLOBAL NETWORKING LISTENERS ---
        // These are set up once on page load to prevent race conditions.

        window.addEventListener('matchmaking-connected', () => {
            showNetworkStatus('Connected to matchmaking service.');
        });

        window.addEventListener('matchmaking-error', (e) => {
            showNetworkStatus(e.detail.message, true);
        });

        window.addEventListener('matchmaking-disconnected', () => {
            showNetworkStatus('Disconnected from matchmaking service.', true);
        });

        function createPlayer(peerId, nametag) {
            // This function is called by network events.
            // It needs access to the game's scene, which is only available after initGame.
            if (!gameScene || !gameFont) {
                console.log(`[UI] Scene not ready. Queuing creation of player ${peerId}`);
                playerCreateQueue.push({ peerId, nametag });
                return;
            }
            if (!gameFont) {
                console.error("Attempted to create player nametag before font was loaded.");
                // We can still create the player mesh, just without the nametag.
            }
            console.log(`Creating player for ${peerId} (${nametag})`);
            const playerMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1.8, 1), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
            gameScene.add(playerMesh);

            let nametagMesh = null; // Initialize as null
            if (gameFont && gameScene) { // Ensure both scene and font are ready
                const textGeometry = new TextGeometry(nametag, { font: gameFont, size: 0.2, height: 0.02 });
                const textMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
                nametagMesh = new THREE.Mesh(textGeometry, textMaterial);
                nametagMesh.geometry.center();
                gameScene.add(nametagMesh);
            } else {
                console.warn(`[UI] gameFont not ready when creating player ${peerId}. Nametag will be missing.`);
            }

            players[peerId] = { mesh: playerMesh, nametagMesh: nametagMesh, nametag: nametag, position: new THREE.Vector3(), quaternion: new THREE.Quaternion() };
        }

        window.addEventListener('game-initialized', (e) => {
            // The game.js file will dispatch this event when it's ready.
            gameScene = e.detail.scene;
            shootHandler = e.detail.handleShoot;
            gameFont = e.detail.font; // Make sure game.js dispatches the font

            // Now that the game is ready, process any players that were queued.
            console.log(`[UI] Game initialized. Processing ${playerCreateQueue.length} queued players.`);
            while (playerCreateQueue.length > 0) {
                const playerData = playerCreateQueue.shift();
                createPlayer(playerData.peerId, playerData.nametag);
            }
        });

        // This event is dispatched from network.js for the host when a new player's connection is open.
        window.addEventListener('host-player-joined', (event) => {
            console.log('[UI] "host-player-joined" event:', event.detail);
            // The 'player-list-updated' event will be fired separately to update the UI for everyone.
        });

        window.addEventListener('peer-ready', (event) => {
            console.log('[UI] "peer-ready" event received.', event.detail);
            myPeerId = event.detail.peerId; // Store our ID
            // If we are already on the host screen, it means we were waiting for the peer ID.
            // Now we can request the room code.
            if (isHost && hostLobby.style.display === 'block') {
                hostGame(myPeerId);
            }
        });

        window.addEventListener('game-hosted-success', (e) => {
            const { roomCode } = e.detail;
            if (isHost) {
                hostIdDisplay.value = roomCode;
            }
        });

        window.addEventListener('data-received', (event) => {
            console.log('[UI] "data-received" event:', event.detail);
            const { peerId, data } = event.detail;
            if (!data.type) return;

            if (data.type === 'state') {
                // This logic should be in game.js, but for now, we handle it here.
                // When state updates come in, find the corresponding player and update their position.
                // This is for remote players. The local player's position is handled by the physics engine.
                const player = players[peerId];
                if (player) {
                    player.position.copy(data.position);
                    player.quaternion.copy(data.quaternion);
                }
            } else if (data.type === 'shoot') {
                if (shootHandler) shootHandler(new THREE.Vector3().copy(data.direction), data.weapon);
            } else if (data.type === 'new-player') {
                if (!players[data.peerId]) {
                    createPlayer(data.peerId, data.nametag);
                }
            } else if (data.type === 'welcome') {
                // This is for the newly joined client
                joinLobby.style.display = 'none';
                hostLobby.style.display = 'block';
                hostLobby.innerHTML = '<h3>Connected to lobby. Waiting for host to start...</h3>';
                data.players.forEach(p => {
                    if (p.peerId !== getMyId() && !players[p.peerId]) {
                        createPlayer(p.peerId, p.nametag);
                    }
                });
            }
            else if (data.type === 'player-list') { // Client receives this
                // This is for clients already in the lobby when another joins/leaves
                dispatchNetworkEvent('player-list-updated', { players: data.players });
            }
            else if (data.type === 'start-game') {
                // This is for clients when the host starts the game
                dispatchNetworkEvent('game-started');
            } else if (data.type === 'player-left') {
                // This is for clients when another player leaves
                // The 'player-disconnected' event is already handled globally
                // but we might want to update the player list in the lobby if the game hasn't started.
                if (lobby.style.display === 'block' && !isHost) {
                    // A better approach is for the host to send an updated player list.
                }
            } else if (data.type === 'player-hit') {
                // This is received by the player who was hit
                if (data.targetId === getMyId()) {
                    // Find the player's body in game.js and apply damage
                    // This requires exporting the playerBody from game.js or a function to apply damage
                    console.log(`I've been hit by ${peerId} for ${data.damage} damage!`);
                    // Example: applyDamage(data.damage);
                }
            }
        });

        window.addEventListener('player-list-updated', (event) => {
            console.log('[UI] "player-list-updated" event:', event.detail);
            updatePlayerList(event.detail.players);
            if (!isHost) startGameButton.style.display = 'none';
        });

        window.addEventListener('player-disconnected', (event) => {
            console.log('[UI] "player-disconnected" event:', event.detail);
            const { peerId } = event.detail;
            if (players[peerId] && players[peerId].nametagMesh && gameScene) {
                gameScene.remove(players[peerId].nametagMesh);
            }
            if (players[peerId] && gameScene) {
                gameScene.remove(players[peerId].mesh);
                delete players[peerId];
            } else {
                console.log(`Player ${peerId} not in game scene, but disconnected.`);
            }
            showNetworkStatus(`A player disconnected.`, true);
            if (isHost && lobby.style.display === 'block') {
                // Host needs to update everyone's player list
                const connections = getConnections();
                const players = connections.map(c => ({ nametag: c.metadata.nametag })).concat({ nametag });
                updatePlayerList(players);
            }
        });

        window.addEventListener('connection-open', (event) => {
            console.log('[UI] "connection-open" event:', event.detail);
            showNetworkStatus(`Connected to ${event.detail.peerId}!`);
        });

        window.addEventListener('connection-error', (event) => {
            console.error('[UI] "connection-error" event:', event.detail);
            showNetworkStatus(`Error: ${event.detail.error.type || 'Connection failed'}`, true);
        });

        window.addEventListener('game-started', () => {
            console.log('[UI] "game-started" event received. Launching multiplayer game.');
            launchMultiplayerGame();
        });

        window.addEventListener('host-peer-id-received', (e) => {
            const { peerId } = e.detail;
            if (peerId) {
                showNetworkStatus(`Host found. Connecting...`);
                connectToHost(peerId);
            } else {
                showNetworkStatus('Could not find a game with that room code.', true);
            }
        });


    </script>
</body>
</html>